name: android-debug-apk

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Android cmdline-tools
        run: |
          set -e
          SDK="$HOME/android-sdk"
          mkdir -p "$SDK/cmdline-tools"
          curl -sSL -o /tmp/cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q /tmp/cmdline-tools.zip -d "$SDK/cmdline-tools"
          mkdir -p "$SDK/cmdline-tools/latest"
          rsync -a "$SDK/cmdline-tools/cmdline-tools/" "$SDK/cmdline-tools/latest/"
          echo "ANDROID_SDK_ROOT=$SDK" >> $GITHUB_ENV
          echo "ANDROID_HOME=$SDK" >> $GITHUB_ENV
          # Install required SDK components. Install both 35 and 36 build-tools to avoid on-the-fly downloads.
          yes | "$SDK/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$SDK" --install \
            "platform-tools" \
            "platforms;android-36" \
            "build-tools;36.0.0" \
            "build-tools;35.0.0" \
            "ndk;28.2.13676358"
          yes | "$SDK/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$SDK" --licenses || true

      - name: Restore keystore from secrets (or generate debug keystore)
        env:
          ANDROID_KEYSTORE_B64: ${{ secrets.KODI_ANDROID_KEYSTORE_BASE64 }}
          KODI_ANDROID_STORE_PASSWORD: ${{ secrets.KODI_ANDROID_STORE_PASSWORD }}
          KODI_ANDROID_KEY_ALIAS: ${{ secrets.KODI_ANDROID_KEY_ALIAS }}
          KODI_ANDROID_KEY_PASSWORD: ${{ secrets.KODI_ANDROID_KEY_PASSWORD }}
        shell: bash
        run: |
          set -euo pipefail
          KS="$RUNNER_TEMP/android.keystore"
          if [ -n "${ANDROID_KEYSTORE_B64:-}" ]; then
            # Try to decode secret content; be tolerant to formatting using --ignore-garbage
            if printf '%s' "$ANDROID_KEYSTORE_B64" | base64 -d --ignore-garbage > "$KS" 2>/dev/null; then
              echo "Using keystore from secrets"
              :
            else
              echo "Warning: failed to decode KODI_ANDROID_KEYSTORE_BASE64, generating debug keystore instead" >&2
              keytool -genkey -v -keystore "$KS" -storetype JKS -keyalg RSA -keysize 2048 -validity 10000 \
                -alias androiddebugkey -storepass android -keypass android \
                -dname "CN=Android Debug,O=Android,C=US"
              export KODI_ANDROID_STORE_PASSWORD=android
              export KODI_ANDROID_KEY_ALIAS=androiddebugkey
              export KODI_ANDROID_KEY_PASSWORD=android
            fi
          else
            echo "KODI_ANDROID_KEYSTORE_BASE64 not set; generating debug keystore" >&2
            keytool -genkey -v -keystore "$KS" -storetype JKS -keyalg RSA -keysize 2048 -validity 10000 \
              -alias androiddebugkey -storepass android -keypass android \
              -dname "CN=Android Debug,O=Android,C=US"
            export KODI_ANDROID_STORE_PASSWORD=android
            export KODI_ANDROID_KEY_ALIAS=androiddebugkey
            export KODI_ANDROID_KEY_PASSWORD=android
          fi
          echo "KODI_ANDROID_STORE_FILE=$KS" >> $GITHUB_ENV
          echo "KODI_ANDROID_STORE_PASSWORD=${KODI_ANDROID_STORE_PASSWORD:-android}" >> $GITHUB_ENV
          echo "KODI_ANDROID_KEY_ALIAS=${KODI_ANDROID_KEY_ALIAS:-androiddebugkey}" >> $GITHUB_ENV
          echo "KODI_ANDROID_KEY_PASSWORD=${KODI_ANDROID_KEY_PASSWORD:-android}" >> $GITHUB_ENV

      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Setup Gradle cache
        uses: gradle/gradle-build-action@v3

      - name: Build Debug APK
        run: |
          ./gradlew :xbmc:assembleDebug -x lint --no-daemon

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: xbmc-debug-apk
          path: xbmc/build/outputs/apk/debug/xbmc-debug.apk
