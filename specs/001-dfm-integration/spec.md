# Feature Specification: DFM 弹幕集成

**Feature Branch**: `001-dfm-integration`  
**Created**: 2025-11-21  
**Status**: Draft  
**Input**: User description: "todos/dfm.md 参考该文档，设计实现DFM的集成任务"

## Clarifications

### Session 2025-11-21

- Q: 本阶段需要支持的本地弹幕文件格式与识别策略？ → A: 仅 Bilibili XML（.xml）；基于扩展名识别（见 FR-022）
- Q: 弹幕覆盖层与 OSD（播放器控制层）的层级关系？ → A: 弹幕在视频之上、OSD 之下；不自动淡出或回避
- Q: MVP 需支持的弹幕类型范围？ → A: 全类型（Bilibili XML 定义：滚动/顶部/底部/高级定位与样式）
- Q: 倍速播放时的弹幕时机与滚动速度策略？ → A: 事件时机随媒体时间推进，滚动速度按倍速同比例缩放
- Q: 按“媒体维度”持久化弹幕偏好的唯一键如何定义？ → A: 绝对路径 + 文件大小 + 修改时间（MediaKey）

### Packaging & Upstream Compliance

- 本功能以产品风味变体（productFlavor）`dfmExperimental` 提供，默认 `vanilla` 变体不包含相关功能代码与依赖，保持与上游一致（不发生功能分歧）。
- 仅在 `dfmExperimental` 下构建与验证（如 `:xbmc:assembleDfmExperimentalDebug`）；默认构建与发布流程继续使用 `vanilla`。
- 源集边界约束（防止测试/实验代码误入主编译）：
  - 主源集仅指向 `xbmc/src/main/java`（及对应 `res`/`AndroidManifest.xml`），禁止新增平行 `xbmc/java/` 树或通配整棵 `src/`。
  - `dfmExperimental` 源集仅指向 `xbmc/src/dfmExperimental/java` 与 `xbmc/src/dfmExperimental/res`；`main` 必须显式排除 `dfmExperimental/**` 与 `dfmExperimentalDebugUnitTest/**`。
  - 变体专属单测仅使用 `xbmc/src/dfmExperimentalDebugUnitTest/java`，不得放在通用 `src/test` 或 `src/dfmExperimentalTest`。
- Manifest/packaging 约束：遵循仓库配置 `android { packaging { jniLibs { useLegacyPackaging = true } } }`，并排除未裁剪符号库（`**/libkodi.unstripped.so`）以保持 APK 体积与合规。
- 构建自检（提交前必跑）：`:xbmc:assembleDebug -x lint`、`:xbmc:assembleDfmExperimentalDebug -x lint`、`:xbmc:testDfmExperimentalDebugUnitTest`。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 观看中显示并同步弹幕 (Priority: P1)

作为观看者，我在播放视频时可以开启弹幕显示，且弹幕与播放进度保持同步；当我暂停、恢复、快进/快退或切到前后台后返回时，弹幕能对应暂停/恢复/跳转与状态保持。

**Why this priority**: 这是弹幕体验的最低可用价值（MVP），直接影响观看体验与是否能继续推进后续数据源集成。

**Independent Test**: 不依赖外部数据源，使用内置“动态注入”测试入口即可验证显示/同步/生命周期行为。

**Acceptance Scenarios**:

1. Given 播放器处于播放状态 When 用户开启弹幕 Then 屏幕出现滚动弹幕并与当前进度对齐
2. Given 正在显示弹幕 When 用户暂停播放 Then 弹幕停止滚动且保持显示位置
3. Given 正在显示弹幕 When 用户拖动到新位置 Then 弹幕在 2 秒内与新进度重新对齐
4. Given 正在显示弹幕 When 应用切至后台再返回 Then 弹幕状态（开关、样式、可见性）保持不变
5. Given 字幕已开启 When 用户开启弹幕 Then 字幕保持显示；如出现遮挡，用户可通过同屏数量/行数等设置自行调节


---

### User Story 2 - 基于视频路径发现与选择“弹幕轨” (Priority: P2)

作为观看者，当我播放本地视频时，系统会在视频所在路径下依据“字幕匹配逻辑”发现可用的“弹幕轨”（来自相匹配的弹幕文件）；若存在多个候选轨，我可以在候选列表中选择或切换当前弹幕轨。

**Why this priority**: 本阶段目标为“最快落地、最少改动”，先通过本地文件实现稳定可靠的弹幕体验，同时为后续插件扩展保留一致的“轨”抽象。

**Independent Test**: 准备若干视频及同目录下的弹幕文件，覆盖“唯一样本、多个候选、无候选”三类场景，验证轨道发现、自动选择/手动选择与降级路径；切换轨时验证同步恢复与状态保持。

**Acceptance Scenarios**:

1. Given 视频目录中存在与视频同名的弹幕文件 When 开始播放 Then 系统自动生成并选择该弹幕轨并开始显示
2. Given 视频目录中存在多个可能匹配的弹幕文件 When 开始播放 Then 系统展示候选弹幕轨列表并允许用户选择其一后开始显示
3. Given 播放过程中用户切换到另一条弹幕轨 When 切换完成 Then 弹幕在 2 秒内恢复与当前播放进度同步
4. Given 视频目录中不存在可匹配的弹幕文件 When 开始播放 Then 系统提示“未找到弹幕文件”，播放不受影响且可稍后手动选择

---

### User Story 3 - 调整样式、密度与过滤 (Priority: P3)

作为观看者，我可以在观看过程中调整弹幕字号、速度、透明度、同屏数量与行数上限，并可按关键字/类型进行过滤，必要时对时间轴做细微偏移以校准。

**Why this priority**: 个性化可显著提升可读性与观感，减少遮挡与噪声。

**Independent Test**: 不依赖具体数据源，加载任意弹幕后调整设置，观察即时生效与持久化（会话范围内）。

**Acceptance Scenarios**:

1. Given 默认设置 When 用户修改任一样式项 Then 弹幕显示在 1 秒内按新设置生效
2. Given 弹幕密度较高 When 用户降低同屏上限 Then 可见弹幕数量随之减少且不影响播放
3. Given 存在干扰性弹幕 When 用户设置关键字过滤 Then 被过滤的弹幕不再显示
4. Given 弹幕与画面略有错位 When 用户调整时间偏移 Then 弹幕与画面重新对齐

### Edge Cases

- 视频路径非本地可访问（如流式/受限路径）时不进行目录扫描，保留手动选择能力
- 多个候选文件命名近似时，提供清晰区分信息（如附加标识/时间/大小），避免误选
- 无法读取或文件损坏时，明确提示并允许更换文件；播放不受影响
- 极高弹幕密度时，系统应限制同屏数量/行数，保障可读性与流畅度
- 旋转、分屏或切换渲染视图后，弹幕覆盖层应正常恢复；OSD 遮挡策略参见 FR-023
- OSD 出现时，弹幕位于下层可被遮挡，不自动淡出或回避；参见 FR-023，可通过同屏数量/行数或临时关闭弹幕自行处理
- 避免重复或近似重复内容导致的刷屏

## Requirements *(mandatory)*

### Functional Requirements

- FR-001: 系统必须提供弹幕覆盖层的总开关，可在播放过程中即时开启/关闭（默认关闭），入口位于播放页按钮与设置面板
- FR-002: 弹幕显示必须与播放进度同步，支持开始/暂停/继续/Seek/停止等状态映射；倍速策略：事件时机随媒体时间推进，滚动速度按播放倍速同比例缩放
- FR-003: 前后台与屏幕旋转后，弹幕开关与显示状态应保持一致并自动恢复
- FR-004: 系统应支持通过内置“动态注入”方式添加测试弹幕，用于无文件场景的验证
- FR-005: 系统必须在“视频所在目录”自动扫描并识别“匹配的弹幕文件”，匹配规则参考字幕命名逻辑（同名优先，附加标识次之）
- FR-006: 当存在多个候选时，系统必须提供清晰的候选“弹幕轨（DanmakuTrack）”列表以供选择；若仅有唯一候选则自动加载。列表项至少包含：文件名、大小、修改时间；必要时展示路径片段用于区分。
- FR-007: 当不存在候选时，系统必须明确提示并允许用户稍后手动选择；播放流程不受影响
- FR-008: 成功加载后，弹幕应在 2 秒内开始显示，并在 Seek 后保持时间对齐
- FR-009: 系统必须支持样式与密度设置：字号、速度、透明度、同屏数量与行数上限，并即时生效；支持按“弹幕轨”保存个性化配置
- FR-010: 系统必须提供基础过滤能力（按关键字与类型），过滤后内容不再显示
- FR-011: 系统必须提供时间轴微调能力（正/负偏移），用于校准弹幕与画面；偏移为“弹幕轨”级别
- FR-012: 对于不可读或损坏文件，系统必须给出错误提示并允许更换；不得影响播放
- FR-013: 弹幕渲染性能必须满足 SC-003 的量化标准（连续播放 30 分钟期间，肉眼可感知的卡顿次数 ≤ 1 次且单次持续 < 0.5 秒），且不产生交互阻塞
- FR-014: 用户在本会话内的弹幕设置与所选“弹幕轨”应被记忆，并支持按媒体维度持久化偏好（MediaKey = 绝对路径 + 文件大小 + 修改时间）
- FR-015: 系统必须引入“弹幕轨（DanmakuTrack）”概念，独立于 Kodi 字幕轨，二者互不干扰
- FR-016: 弹幕与字幕开关独立控制，默认共显；任一开关变化不应改变另一方状态
- FR-017: 系统必须提供“弹幕”独立开关与“弹幕轨（DanmakuTrack）”选择入口（OSD 与设置均可访问），避免与“字幕轨”混淆。具体：
  - OSD：提供“开启/关闭弹幕”操作与“选择弹幕轨”入口（图标与文案应清晰区分字幕）。
  - 设置：新增“播放器 > 弹幕”面板，包含开关与样式/密度/过滤项。
- FR-018: 支持在播放过程中切换“弹幕轨”，切换后在 2 秒内恢复同步与显示，且保留当前样式与过滤偏好（若该轨有历史偏好则优先）
- FR-019: 为后续插件扩展做准备：轨道模型与选择流程应同时适用于“本地文件”和未来“在线/插件来源”，在本阶段仅实现本地文件轨
- FR-020: 引入“轨绑定（Track Binding）”契约：未来插件可将其弹幕数据源与某条弹幕轨进行绑定；播放器侧对“活动弹幕轨”进行统一渲染，插件无需直接参与绘制
- FR-021: 字幕可读性提示与用户自控：当字幕与弹幕同时开启时，系统不进行自动遮挡控制；提供同屏数量/行数等设置供用户自行调节，并在设置面板给予可读性提示

- FR-022: 本阶段仅支持 Bilibili XML（.xml）弹幕文件；基于扩展名（.xml）进行识别与匹配；JSON/ASS/SSA 等其他格式不在本阶段范围

- FR-023: 弹幕覆盖层层级：位于视频之上、OSD 之下；OSD 出现时不触发弹幕自动淡出或避让，仅由层级关系遮挡，且不影响 OSD 操作

- FR-024: 弹幕类型支持：完整支持 Bilibili XML 所有类型（滚动 R→L、顶部固定、底部固定、高级定位/样式），并与播放器时钟保持一致联动（play/pause/seek/speed）

示例说明：采用 [NEEDS CLARIFICATION] 标记仅限关键决策项；若未标记则按上述为固定需求。

### Key Entities *(include if feature involves data)*

- 弹幕文件：存放于与视频相同目录下，名称与视频存在可推断的对应关系
- 媒体标识（MediaKey）：由“绝对路径 + 文件大小 + 修改时间”三元组构成，用于持久化媒体维度偏好
- 弹幕轨（DanmakuTrack）：包含 id、名称、来源类型（本地/在线）、文件/源信息、样式/密度/过滤与时间偏移配置
- 轨候选集合：扫描或发现后得到的可能匹配轨集合，用于自动选择或供用户选择
- 轨管理（逻辑）：负责列举/选择/切换当前轨，并按媒体维度持久化偏好与配置
- 弹幕条目：包含显示时间、文本、类型与样式等，用于在对应时间点呈现；至少含 mode/type（滚动/顶部/底部/定位）、color、size、alpha、position（定位型）
- 弹幕覆盖层/引擎：负责承载显示、与播放器时钟联动（play/pause/seek/speed）、窗口化加载与注入、控制可见性与样式
- 轨绑定（Track Binding）：一种轻量契约/约定，用于将数据源产生的标准化弹幕条目与某条弹幕轨关联；播放器订阅“活动轨”并统一渲染，数据源仅负责产出与绑定

## Success Criteria *(mandatory)*

### Measurable Outcomes

- SC-001: 对于同目录下存在至少一个匹配弹幕文件的本地视频，首次弹幕在 2 秒内出现
- SC-002: Seek 后在 2 秒内恢复到新位置对应的弹幕显示，且与画面绝对偏差 ≤ 200ms（可人工比对）
- SC-003: 连续播放 30 分钟期间，肉眼可感知的卡顿次数 ≤ 1 次且单次持续 < 0.5 秒
- SC-004: 在包含多个候选的场景中，系统自动选择（或用户选择）后的弹幕轨与视频内容的匹配正确率 ≥ 90%
- SC-005: 至少 90% 的用户在 1 次尝试内能找到并成功调整任一弹幕设置项（可用性走查）
- SC-006: 未找到弹幕文件或文件损坏时，用户在 1 次尝试内能理解提示并继续播放，不出现阻断流程
- SC-007: 共显与独立控制：开启/关闭“弹幕”时，字幕开关状态保持不变且字幕持续可见的正确率 100%
- SC-008: 播放过程中切换“弹幕轨”后在 2 秒内恢复同步与显示的成功率 ≥ 95%
 - SC-009: 对包含顶部/底部/定位弹幕的样例，Seek 后 2 秒内位置与时间对齐的正确率 ≥ 95%

## Assumptions

- 本阶段仅支持“本地可访问”的视频路径与同目录弹幕文件；不涉及在线来源与跨目录递归搜索
- 弹幕开关默认关闭，入口同时存在于播放页与设置面板，确保易发现
- 匹配优先级参考字幕逻辑：同名最高优先；带附加标识（如分集/语言/版本）的变体次之；出现并列时由用户选择
- 引入“弹幕轨”概念以对齐未来插件扩展；本阶段仅产出“本地文件”类型的弹幕轨
- 未来插件通过“轨绑定”将弹幕数据关联至某条轨；播放器对“活动弹幕轨”进行统一渲染，插件无须直接调用渲染接口
- 不对弹幕文件内容做网络补全或更新；不采集用户数据

- 本阶段仅解析 Bilibili XML（.xml）弹幕文件，并以扩展名进行识别（同 FR-022）；其他格式暂不支持

## Out of Scope

- 在线弹幕数据源的自动匹配与加载
- 插件化数据源的发现、装配与远程请求限流
- 跨目录或网络路径的弹幕检索
- 非 .xml 格式弹幕的解析（如 JSON/ASS/SSA）
