apply plugin: 'com.android.application'
apply plugin: 'jacoco'

repositories {
    google()
    mavenCentral()
}

android {
    namespace = 'org.xbmc.kodi'
    compileSdk = 36
    // Use side-by-side NDK from Android SDK on CI/local; version pinned for reproducibility
    ndkVersion = "28.2.13676358"
    flavorDimensions "features"
    defaultConfig {
        applicationId = "org.xbmc.kodi"
        minSdk = 24
        targetSdk = 36
        versionCode = 2190702
        versionName = "22.0-ALPHA2"
    }
    buildFeatures {
        buildConfig = true
    }
    productFlavors {
        vanilla {
            dimension "features"
            buildConfigField "boolean", "DANMAKU_ENABLED", "false"
        }
        dfmExperimental {
            dimension "features"
            buildConfigField "boolean", "DANMAKU_ENABLED", "true"
        }
    }
    signingConfigs {
        release {
            keyAlias = System.getenv("KODI_ANDROID_KEY_ALIAS")
            keyPassword = System.getenv("KODI_ANDROID_KEY_PASSWORD")
            storeFile = file(System.getenv("KODI_ANDROID_STORE_FILE"))
            storePassword = System.getenv("KODI_ANDROID_STORE_PASSWORD")
            enableV1Signing = true
            enableV2Signing = true
            enableV3Signing = true
        }
    }
    buildTypes {
        debug {
            signingConfig = signingConfigs.release
        }
        relwithdebinfo {
            signingConfig = signingConfigs.release
        }
        release {
            signingConfig = signingConfigs.release
        }
    }
    aaptOptions {
        ignoreAssetsPattern = '!.svn:!.git:!.ds_store:!*.scc:.*:!CVS:!thumbs.db:!picasa.ini:!*~'
    }
    sourceSets {
        main {
            manifest.srcFile 'AndroidManifest.xml'
            // Compile directly from canonical source tree; keep legacy generated path for compatibility
            java.srcDirs = ['src']
            java {
                // Exclude flavor-specific and test sources from main compilation
                exclude 'dfmExperimental/**'
                exclude 'dfmExperimentalTest/**'
                exclude 'dfmExperimentalDebugUnitTest/**'
            }
            res.srcDirs = ['res']
            assets.srcDirs = ['assets']
            jniLibs.srcDirs = ['lib']
        }
        dfmExperimental {
            java.srcDirs += ['src/dfmExperimental/java']
            res.srcDirs += ['src/dfmExperimental/res']
        }
        testDfmExperimentalDebug {
            java.srcDirs += ['src/dfmExperimentalDebugUnitTest/java']
        }
    }
    packaging {
      jniLibs {
        // Do not include debug-symbol rich unstripped library in APK
        excludes += ["**/libkodi.unstripped.so"]
        useLegacyPackaging = true
      }
    }

    // Toggle for enabling Jacoco on unit tests. Default: disabled（离线插桩将替代 agent 注入）。
    def enableJacocoForUnitTests = providers.gradleProperty("enableJacocoTest").map { it.toBoolean() }.orElse(false)

    testOptions {
        unitTests.all {
            it.jacoco.includeNoLocationClasses = true
            // 默认关闭 Jacoco，如需覆盖率请使用 -PenableJacocoTest=true 打开
            it.jacoco.enabled = enableJacocoForUnitTests.get()
            it.testLogging.events("passed", "skipped", "failed")
            it.reports.junitXml.required = true
            it.reports.html.required = true
            it.reports.junitXml.outputLocation = file("$buildDir/test-results/${it.name}")
            it.reports.html.outputLocation = file("$buildDir/reports/tests/${it.name}")
            // 将 JVM 单测限定在 Robolectric 支持的最高 SDK（不影响 APK target/compileSdk）
            it.systemProperty 'robolectric.enabledSdks', '34'
            // Force test worker JRE to Java 17 to avoid JDK 21 deserialization issues
            it.javaLauncher.set(javaToolchains.launcherFor { languageVersion = JavaLanguageVersion.of(17) })
            // Open necessary JDK internals and avoid generating accessor classes
            it.jvmArgs('--add-opens=java.base/java.lang=ALL-UNNAMED',
                    '--add-opens=java.base/java.lang.invoke=ALL-UNNAMED',
                    '--add-opens=java.base/java.util=ALL-UNNAMED',
                    '--add-opens=java.base/java.lang.reflect=ALL-UNNAMED',
                    '--add-opens=java.base/java.io=ALL-UNNAMED',
                    '--add-opens=java.base/jdk.internal.reflect=ALL-UNNAMED',
                    '--add-exports=java.base/jdk.internal.reflect=ALL-UNNAMED',
                    '--add-exports=java.base/jdk.internal.misc=ALL-UNNAMED',
                    '--add-exports=java.base/sun.reflect.annotation=ALL-UNNAMED',
                    '--add-exports=java.base/sun.reflect.generics.reflectiveObjects=ALL-UNNAMED')
            it.systemProperty 'jdk.reflect.useDirectMethodHandle', 'true'
            // Optional: help diagnose early worker deserialization issues
            it.systemProperty 'java.io.serialization.extendedDebugInfo', 'true'
            it.systemProperty 'java.io.serialization.debug', 'true'
        }
        // Needed for Robolectric to access merged resources when required
        unitTests.includeAndroidResources = true
    }
    lint {
        baseline = file("lint-baseline.xml")
        checkReleaseBuilds = false
    }
}

// no-op: previously had an incomplete afterEvaluate hook

dependencies {
    implementation 'androidx.core:core:1.16.0'
    implementation 'androidx.tvprovider:tvprovider:1.1.0'
    implementation 'com.google.code.gson:gson:2.13.1'
    dfmExperimentalImplementation 'com.github.ctiao:dfm:0.9.25'
    dfmExperimentalImplementation 'androidx.preference:preference:1.2.1'
    testImplementation 'junit:junit:4.13.2'
    // Robolectric provides Android framework shadows for local JVM tests
    testImplementation 'org.robolectric:robolectric:4.12.2'
    // JaCoCo runtime for离线插桩运行（避免以 agent 方式触发反射序列化问题）
    testImplementation "org.jacoco:org.jacoco.agent:${jacoco.toolVersion}:runtime"
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)
    }
}

jacoco {
    toolVersion = "0.8.12"
}

def jacocoExcludes = [
        '**/R.class',
        '**/R$*.class',
        '**/BuildConfig.*',
        '**/Manifest*'
]

tasks.register("jacocoDfmExperimentalDebugUnitTestReport", JacocoReport) {
    dependsOn tasks.named("testDfmExperimentalDebugUnitTest")
    reports {
        xml.required = true
        html.required = true
        html.outputLocation = layout.buildDirectory.dir("reports/jacoco/dfmExperimentalDebugUnitTest/html")
        xml.outputLocation = layout.buildDirectory.file("reports/jacoco/dfmExperimentalDebugUnitTest/jacoco.xml")
    }
    classDirectories.setFrom(files(
            fileTree(dir: "$buildDir/intermediates/javac/dfmExperimentalDebug/classes", exclude: jacocoExcludes),
            fileTree(dir: "$buildDir/tmp/kotlin-classes/dfmExperimentalDebug", exclude: jacocoExcludes)
    ))
    sourceDirectories.setFrom(files("src", "src/dfmExperimental/java"))
    executionData.setFrom(file("$buildDir/jacoco/testDfmExperimentalDebugUnitTest.exec"))
}

tasks.register("jacocoDfmExperimentalDebugUnitTestCoverageVerification", JacocoCoverageVerification) {
    dependsOn tasks.named("testDfmExperimentalDebugUnitTest")
    classDirectories.setFrom(files(
            fileTree(dir: "$buildDir/intermediates/javac/dfmExperimentalDebug/classes", exclude: jacocoExcludes),
            fileTree(dir: "$buildDir/tmp/kotlin-classes/dfmExperimentalDebug", exclude: jacocoExcludes)
    ))
    sourceDirectories.setFrom(files("src", "src/dfmExperimental/java"))
    executionData.setFrom(file("$buildDir/jacoco/testDfmExperimentalDebugUnitTest.exec"))
    violationRules {
        rule {
            limit {
                minimum = 0.8
            }
        }
    }
}

tasks.named("check").configure {
    dependsOn("jacocoDfmExperimentalDebugUnitTestCoverageVerification")
}

// Ensure all JVM test workers run on JDK 17 and have the right module opens
tasks.withType(Test).configureEach { t ->
    t.javaLauncher.set(javaToolchains.launcherFor { languageVersion = JavaLanguageVersion.of(17) })
    t.jvmArgs('--add-opens=java.base/java.lang=ALL-UNNAMED',
            '--add-opens=java.base/java.lang.invoke=ALL-UNNAMED',
            '--add-opens=java.base/java.util=ALL-UNNAMED',
            '--add-opens=java.base/java.lang.reflect=ALL-UNNAMED',
            '--add-opens=java.base/java.io=ALL-UNNAMED',
            '--add-opens=java.base/jdk.internal.reflect=ALL-UNNAMED',
            '--add-exports=java.base/jdk.internal.reflect=ALL-UNNAMED',
            '--add-exports=java.base/jdk.internal.misc=ALL-UNNAMED',
            '--add-exports=java.base/sun.reflect.annotation=ALL-UNNAMED',
            '--add-exports=java.base/sun.reflect.generics.reflectiveObjects=ALL-UNNAMED')
    t.systemProperty 'jdk.reflect.useDirectMethodHandle', 'true'
}

// Fallback: explicitly target the Android unit test task by name
tasks.matching { it.name == "testDfmExperimentalDebugUnitTest" }.configureEach { t ->
    if (t instanceof Test) {
        // 该任务使用 JDK17（与主工具链一致）
        t.javaLauncher.set(javaToolchains.launcherFor { languageVersion = JavaLanguageVersion.of(17) })
        // 方案A：限制为单 worker，避免并发 Worker 在序列化阶段的干扰
        t.maxParallelForks = 1
        t.doFirst {
            t.jvmArgs('--add-opens=java.base/java.lang=ALL-UNNAMED',
                    '--add-opens=java.base/java.lang.invoke=ALL-UNNAMED',
                    '--add-opens=java.base/java.util=ALL-UNNAMED',
                    '--add-opens=java.base/java.lang.reflect=ALL-UNNAMED',
                    '--add-opens=java.base/java.io=ALL-UNNAMED',
                    '--add-opens=java.base/jdk.internal.reflect=ALL-UNNAMED',
                    '--add-exports=java.base/jdk.internal.reflect=ALL-UNNAMED',
                    '--add-exports=java.base/jdk.internal.misc=ALL-UNNAMED',
                    '--add-exports=java.base/sun.reflect.annotation=ALL-UNNAMED',
                    '--add-exports=java.base/sun.reflect.generics.reflectiveObjects=ALL-UNNAMED')
            t.systemProperty 'jdk.reflect.useDirectMethodHandle', 'true'
            t.systemProperty 'java.io.serialization.extendedDebugInfo', 'true'
            t.systemProperty 'java.io.serialization.debug', 'true'
            // 注意：不在此处强改 allJvmArgs，避免触发属性冻结冲突
        }
        // 使用离线插桩：保持 Gradle Jacoco agent 关闭（通过全局 enableJacocoForUnitTests=false 已禁用）
        // 将插桩后的 classes 置于 classpath 前面，并设置离线写入的 exec 位置
        def classesDir = layout.buildDirectory.dir("intermediates/javac/dfmExperimentalDebug/compileDfmExperimentalDebugJavaWithJavac/classes").get().asFile
        def instrumentedDir = layout.buildDirectory.dir("instrumented/dfmExperimentalDebug").get().asFile
        t.dependsOn("instrumentDfmExperimentalDebug")
        t.doFirst {
            t.classpath = files(instrumentedDir) + t.classpath
            t.systemProperty 'jacoco-agent.destfile', file("$buildDir/jacoco/testDfmExperimentalDebugUnitTest.exec").absolutePath
        }
    }
}

// 使用 JaCoCo Ant 进行离线插桩，避免以 JavaAgent 方式触发 JDK 反射/序列化问题
configurations { jacocoAnt }
dependencies { jacocoAnt "org.jacoco:org.jacoco.ant:${jacoco.toolVersion}" }

tasks.register("instrumentDfmExperimentalDebug") {
    dependsOn tasks.named("compileDfmExperimentalDebugJavaWithJavac")
    doLast {
        def classesDir = layout.buildDirectory.dir("intermediates/javac/dfmExperimentalDebug/compileDfmExperimentalDebugJavaWithJavac/classes").get().asFile
        def instrumentedDir = layout.buildDirectory.dir("instrumented/dfmExperimentalDebug").get().asFile
        instrumentedDir.deleteDir()
        instrumentedDir.mkdirs()
        ant.taskdef(resource: 'org/jacoco/ant/antlib.xml', uri: 'jacoco', classpath: configurations.jacocoAnt.asPath)
        ant.'jacoco:instrument'(destdir: instrumentedDir) {
            fileset(dir: classesDir) {
                exclude(name: '**/R.class')
                exclude(name: '**/R$*.class')
                exclude(name: '**/BuildConfig.*')
                exclude(name: '**/Manifest*')
            }
        }
    }
}
