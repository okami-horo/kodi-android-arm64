apply plugin: 'com.android.application'
apply plugin: 'jacoco'

repositories {
    google()
    mavenCentral()
}

android {
    namespace = 'org.xbmc.kodi'
    compileSdk = 36
    // Use side-by-side NDK from Android SDK on CI/local; version pinned for reproducibility
    ndkVersion = "28.2.13676358"
    flavorDimensions "features"
    defaultConfig {
        applicationId = "org.xbmc.kodi"
        minSdk = 24
        targetSdk = 36
        versionCode = 2190702
        versionName = "22.0-ALPHA2"
    }
    buildFeatures {
        buildConfig = true
    }
    productFlavors {
        vanilla {
            dimension "features"
            buildConfigField "boolean", "DANMAKU_ENABLED", "false"
        }
        dfmExperimental {
            dimension "features"
            buildConfigField "boolean", "DANMAKU_ENABLED", "true"
        }
    }
    signingConfigs {
        release {
            keyAlias = System.getenv("KODI_ANDROID_KEY_ALIAS")
            keyPassword = System.getenv("KODI_ANDROID_KEY_PASSWORD")
            storeFile = file(System.getenv("KODI_ANDROID_STORE_FILE"))
            storePassword = System.getenv("KODI_ANDROID_STORE_PASSWORD")
            enableV1Signing = true
            enableV2Signing = true
            enableV3Signing = true
        }
    }
    buildTypes {
        debug {
            signingConfig = signingConfigs.release
        }
        relwithdebinfo {
            signingConfig = signingConfigs.release
        }
        release {
            signingConfig = signingConfigs.release
        }
    }
    aaptOptions {
        ignoreAssetsPattern = '!.svn:!.git:!.ds_store:!*.scc:.*:!CVS:!thumbs.db:!picasa.ini:!*~'
    }
    sourceSets {
        main {
            manifest.srcFile 'AndroidManifest.xml'
            // Compile directly from canonical source tree; keep legacy generated path for compatibility
            java.srcDirs = ['src']
            java {
                // Exclude flavor-specific and test sources from main compilation
                exclude 'dfmExperimental/**'
                exclude 'dfmExperimentalTest/**'
                exclude 'dfmExperimentalDebugUnitTest/**'
            }
            res.srcDirs = ['res']
            assets.srcDirs = ['assets']
            jniLibs.srcDirs = ['lib']
        }
        dfmExperimental {
            java.srcDirs += ['src/dfmExperimental/java']
            res.srcDirs += ['src/dfmExperimental/res']
        }
        testDfmExperimentalDebug {
            java.srcDirs += ['src/dfmExperimentalDebugUnitTest/java']
        }
    }
    packaging {
      jniLibs {
        // Do not include debug-symbol rich unstripped library in APK
        excludes += ["**/libkodi.unstripped.so"]
        useLegacyPackaging = true
      }
    }

    testOptions {
        unitTests.all {
            it.jacoco.includeNoLocationClasses = true
            it.testLogging.events("passed", "skipped", "failed")
            it.reports.junitXml.required = true
            it.reports.html.required = true
            it.reports.junitXml.outputLocation = file("$buildDir/test-results/${it.name}")
            it.reports.html.outputLocation = file("$buildDir/reports/tests/${it.name}")
            // Force test worker JRE to Java 17 to avoid JDK 21 deserialization issues
            it.javaLauncher.set(javaToolchains.launcherFor { languageVersion = JavaLanguageVersion.of(17) })
            // Open necessary JDK internals and avoid generating accessor classes
            it.jvmArgs('--add-opens=java.base/java.lang=ALL-UNNAMED',
                    '--add-opens=java.base/jdk.internal.reflect=ALL-UNNAMED',
                    '--add-exports=java.base/jdk.internal.reflect=ALL-UNNAMED')
            it.systemProperty 'jdk.reflect.useDirectMethodHandle', 'true'
        }
        // Needed for Robolectric to access merged resources when required
        unitTests.includeAndroidResources = true
    }
}

// no-op: previously had an incomplete afterEvaluate hook

dependencies {
    implementation 'androidx.core:core:1.16.0'
    implementation 'androidx.tvprovider:tvprovider:1.1.0'
    implementation 'com.google.code.gson:gson:2.13.1'
    dfmExperimentalImplementation 'com.github.ctiao:dfm:0.9.25'
    testImplementation 'junit:junit:4.13.2'
    // Robolectric provides Android framework shadows for local JVM tests
    testImplementation 'org.robolectric:robolectric:4.12.2'
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)
    }
}

jacoco {
    toolVersion = "0.8.12"
}

def jacocoExcludes = [
        '**/R.class',
        '**/R$*.class',
        '**/BuildConfig.*',
        '**/Manifest*'
]

tasks.register("jacocoDfmExperimentalDebugUnitTestReport", JacocoReport) {
    dependsOn tasks.named("testDfmExperimentalDebugUnitTest")
    reports {
        xml.required = true
        html.required = true
        html.outputLocation = layout.buildDirectory.dir("reports/jacoco/dfmExperimentalDebugUnitTest/html")
        xml.outputLocation = layout.buildDirectory.file("reports/jacoco/dfmExperimentalDebugUnitTest/jacoco.xml")
    }
    classDirectories.setFrom(files(
            fileTree(dir: "$buildDir/intermediates/javac/dfmExperimentalDebug/classes", exclude: jacocoExcludes),
            fileTree(dir: "$buildDir/tmp/kotlin-classes/dfmExperimentalDebug", exclude: jacocoExcludes)
    ))
    sourceDirectories.setFrom(files("src", "src/dfmExperimental/java"))
    executionData.setFrom(file("$buildDir/jacoco/testDfmExperimentalDebugUnitTest.exec"))
}

tasks.register("jacocoDfmExperimentalDebugUnitTestCoverageVerification", JacocoCoverageVerification) {
    dependsOn tasks.named("testDfmExperimentalDebugUnitTest")
    classDirectories.setFrom(files(
            fileTree(dir: "$buildDir/intermediates/javac/dfmExperimentalDebug/classes", exclude: jacocoExcludes),
            fileTree(dir: "$buildDir/tmp/kotlin-classes/dfmExperimentalDebug", exclude: jacocoExcludes)
    ))
    sourceDirectories.setFrom(files("src", "src/dfmExperimental/java"))
    executionData.setFrom(file("$buildDir/jacoco/testDfmExperimentalDebugUnitTest.exec"))
    violationRules {
        rule {
            limit {
                minimum = 0.8
            }
        }
    }
}

tasks.named("check").configure {
    dependsOn("jacocoDfmExperimentalDebugUnitTestCoverageVerification")
}

// Ensure all JVM test workers run on JDK 17 and have the right module opens
tasks.withType(Test).configureEach { t ->
    t.javaLauncher.set(javaToolchains.launcherFor { languageVersion = JavaLanguageVersion.of(17) })
    t.jvmArgs('--add-opens=java.base/java.lang=ALL-UNNAMED',
            '--add-opens=java.base/jdk.internal.reflect=ALL-UNNAMED',
            '--add-exports=java.base/jdk.internal.reflect=ALL-UNNAMED')
    t.systemProperty 'jdk.reflect.useDirectMethodHandle', 'true'
}

// Fallback: explicitly target the Android unit test task by name
tasks.matching { it.name == "testDfmExperimentalDebugUnitTest" }.configureEach { t ->
    if (t instanceof Test) {
        t.javaLauncher.set(javaToolchains.launcherFor { languageVersion = JavaLanguageVersion.of(17) })
        t.doFirst {
            t.jvmArgs('--add-opens=java.base/java.lang=ALL-UNNAMED',
                    '--add-opens=java.base/jdk.internal.reflect=ALL-UNNAMED',
                    '--add-exports=java.base/jdk.internal.reflect=ALL-UNNAMED')
            t.systemProperty 'jdk.reflect.useDirectMethodHandle', 'true'
        }
    }
}
